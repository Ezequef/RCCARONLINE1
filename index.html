<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>RC Car — Mobile Joystick Control</title>
<style>
html,body{height:100%;margin:0;background:#000;touch-action:none;user-select:none;font-family:system-ui,Arial}
button{position:fixed;width:18vw;height:18vw;max-width:110px;max-height:110px;border-radius:50%;border:3px solid rgba(0,255,255,.6);background:rgba(0,40,60,.6);color:#0ff;font-size:4vw;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);box-shadow:0 0 12px rgba(0,255,255,.4);transition:.15s;touch-action:none}
button:active{transform:scale(1.15);background:rgba(0,100,150,.7)}
#up{bottom:32vh;right:8vw}
#down{bottom:8vh;right:8vw}
#left{bottom:20vh;left:8vw}
#right{bottom:20vh;right:28vw}
#status{position:fixed;top:10px;left:10px;display:flex;gap:8px;align-items:center;color:#0ff;font-size:13px}
#dot{width:12px;height:12px;border-radius:50%;background:#ff0044;box-shadow:0 0 8px #ff0044}
#moveBtn{position:fixed;top:10px;right:10px;width:40px;height:40px;background:rgba(0,255,255,.6);border-radius:50%;border:2px solid #0ff;color:#000;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;user-select:none;cursor:pointer;backdrop-filter:blur(6px);z-index:1000;}
</style>
</head>
<body>
<div id="status">
    <div id="dot" title="WebSocket status"></div>
    <div id="stext">WS: desconectado</div>
</div>

<button id="up">▲</button>
<button id="down">▼</button>
<button id="left">◄</button>
<button id="right">►</button>
<div id="moveBtn" title="Mover Joysticks">↕</div>

<script>
const WS_URL=(function(){try{const q=new URLSearchParams(location.search);if(q.get('ws'))return q.get('ws')}catch(e){}return(location.protocol==='https:'?'wss://rccaronline.onrender.com':'ws://'+location.host)})();
let s;
let activeKeys={};

function conn(){
    s=new WebSocket(WS_URL);
    s.onclose=()=>setTimeout(conn,1200);
    s.onopen=()=>updateStatus(true);
    s.onmessage=e=>{};
    s.onerror=e=>updateStatus(false);
}

function updateStatus(ok){
    const dot=document.getElementById('dot');
    const stext=document.getElementById('stext');
    if(ok){
        dot.style.background='#00ff00';
        dot.style.boxShadow='0 0 8px #00ff00';
        stext.textContent='WS: conectado';
    }else{
        dot.style.background='#ff0044';
        dot.style.boxShadow='0 0 8px #ff0044';
        stext.textContent='WS: desconectado';
    }
}
conn();

function send(c){
    if(!s||s.readyState!==1)return;
    s.send(JSON.stringify({type:'controle',comando:c}));
}

// Controle com parar automático restaurado
function updateKeys(){
    if(activeKeys['w']) send('frente');
    else if(activeKeys['s']) send('tras');
    else if(activeKeys['a']) send('esquerda');
    else if(activeKeys['d']) send('direita');
    else send('parar');
}

function press(btn,key){
    btn.addEventListener('pointerdown',e=>{e.preventDefault();activeKeys[key]=true;updateKeys()});
    btn.addEventListener('pointerup',e=>{e.preventDefault();activeKeys[key]=false;updateKeys()});
    btn.addEventListener('pointerleave',()=>{activeKeys[key]=false;updateKeys()});
}
press(document.getElementById('up'),'w');
press(document.getElementById('down'),'s');
press(document.getElementById('left'),'a');
press(document.getElementById('right'),'d');

onkeydown=e=>{let k=e.key.toLowerCase();if(['w','a','s','d'].includes(k)){activeKeys[k]=true;updateKeys()}};
onkeyup=e=>{let k=e.key.toLowerCase();if(['w','a','s','d'].includes(k)){activeKeys[k]=false;updateKeys()}};

// Botão para mover joystick na tela
const moveBtn=document.getElementById('moveBtn');
let dragging=false,offsetX=0,offsetY=0;
moveBtn.addEventListener('pointerdown',e=>{
    dragging=true;
    offsetX=e.clientX-moveBtn.offsetLeft;
    offsetY=e.clientY-moveBtn.offsetTop;
});
document.addEventListener('pointermove',e=>{
    if(dragging){
        moveBtn.style.left=(e.clientX-offsetX)+'px';
        moveBtn.style.top=(e.clientY-offsetY)+'px';
    }
});
document.addEventListener('pointerup',()=>{dragging=false;});
</script>
</body>
</html>
